
# This test assesses the convergence of the monolithic FSI solver
# for the following configuration:
#
# - Prescribed mesh movement with a pre-set manufactured field 
#   (RigidMeshMovement), controlled with preset_fsi_mms_moving = true.
#   This mesh position MMS is for now controlled within the solver.
#
# - Manufactured velocity and pressure prescribed below.
#   The prescribed fields vary in space and time and are not captured 
#   exactly by P2-P1 elements or BDF2 integrator.
# 
# An L2/inf spatial norm and an Linf time norm are considered.
# At least 2nd order is obtained for space-time convergence for all
# fields, showing that the time-dependent boundary conditions should be 
# correctly implemented.
#
# In this test, weakly enforced boundary conditions are not tested.
# The mesh movement is uncoupled from the flow, and mesh position and
# velocity boundary conditions are each enforced strongly to the
# manufactured solution.

subsection Dimension
  set dimension = 2
end

subsection Timer
  set enable timer = false
end

subsection Output
  set write results    = false
  set output directory = ../data/mms/
  set output prefix    = solution
end

subsection Mesh
  # Mesh is prescribed in MMS section
end

subsection Time integration
  set verbosity = quiet
  set dt        = 0.1
  set t_initial = 0
  set t_end     = 0.5
  set scheme    = BDF2
end

subsection Nonlinear solver
  set verbosity            = quiet
  set tolerance            = 1e-10
  set divergence_tolerance = 1e+4
  set max_iterations       = 20
  set enable_line_search   = true
  set analytic_jacobian    = true
end

subsection Linear solver
  set verbosity      = quiet
  set method         = direct_mumps
  set reuse          = true
end

subsection FiniteElements
  set Velocity degree            = 2
  set Pressure degree            = 1
  set Mesh position degree       = 1
  set Lagrange multiplier degree = 2
end

subsection Physical properties
  set number of fluids = 1
  subsection Fluid 0
    set density             = 1
    set kinematic viscosity = 1
  end

  set number of pseudosolids = 1
  subsection Pseudosolid 0
    subsection lame lambda
      set Function expression = 1
    end
    subsection lame mu
      set Function expression = 1
    end
  end
end

subsection FSI
  set verbosity       = quiet
  set enable coupling = false
  set spring constant = 1
end

subsection Initial conditions
  set to mms = true
end

subsection Fluid boundary conditions
  set number = 2
  set fix pressure constant = true
  subsection boundary 0
    set id   = 2
    set name = OuterBoundary
    set type = velocity_mms
  end
  subsection boundary 1
    set id   = 3
    set name = InnerBoundary
    set type = velocity_mms # Not testing "weak_no_slip"
  end
end

subsection Pseudosolid boundary conditions
  set number = 2
  subsection boundary 0
    set id   = 2
    set name = OuterBoundary
    set type = position_mms
  end
  subsection boundary 1
    set id   = 3
    set name = InnerBoundary
    set type = position_mms # Not testing "coupled_to_fluid"
  end
end

subsection Manufactured solution
  set enable            = true
  set type              = spacetime
  set convergence steps = 2

  subsection Space convergence
    set use dealii cube mesh        = false
    set use dealii holed plate mesh = false # Could also be used
    set mesh prefix                 = ../../mms_meshes/holed
    set compute L2 norm      = true
    set compute Li norm      = true
    set compute H1 norm      = false
  end

  subsection Time convergence
    set norm                 = Linfty
    set use spatial mesh     = true
    set spatial mesh index   = 2
    set time step reduction  = 0.5
  end

  subsection exact velocity
    set Function expression = cos(t) * (x^3 + y^3); cos(x*y) * t^3
  end
  subsection exact pressure
    set Function expression = sin(x+y) * cos(t)
  end

  subsection exact mesh displacement
    subsection space component
      set preset = rigid_motion_kernel
      subsection rigid_motion_kernel
        set translation = 0.1, 0.05
        set r0          = 0.15
        set r1          = 0.45
        set center      = 0.5, 0.5
      end
    end
    subsection time component
      set Function expression = 0.5 * sin(2.*pi*t)
    end
  end
end

subsection Debug
  set compare jacobian matrix with fd        = false
  set analytical_jacobian_absolute_tolerance = 1e-6
  set analytical_jacobian_relative_tolerance = 1e-4
end